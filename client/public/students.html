<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Students Management - DojoFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #1e293b, #7e22ce, #1e293b);
            min-height: 100vh;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #7e22ce;
            color: white;
        }
        .btn-primary:hover {
            background: #6b21a8;
        }
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-active {
            background: #dcfce7;
            color: #166534;
        }
        .badge-inactive {
            background: #f3f4f6;
            color: #4b5563;
        }
        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #7e22ce;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Students Management</h1>
                    <p class="text-gray-600">Manage your dojo students - <span id="student-count">0</span> total students</p>
                </div>
                <button onclick="window.location.href='/'" class="btn btn-secondary">
                    ‚Üê Back to Home
                </button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Search by name, email, or phone..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
                        onkeyup="filterStudents()"
                    />
                </div>
                <select 
                    id="status-filter" 
                    class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
                    onchange="filterStudents()"
                >
                    <option value="All">All Status</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                </select>
                <button onclick="openAddModal()" class="btn btn-primary">
                    + Add Student
                </button>
            </div>
        </div>

        <!-- Students Table -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div id="loading-state" class="p-12 text-center">
                <div class="loading mx-auto mb-4"></div>
                <p class="text-gray-600">Loading students...</p>
            </div>
            <div id="table-container" style="display: none;">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Age</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Belt Rank</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="students-table-body" class="divide-y divide-gray-200">
                        <!-- Students will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="empty-state" style="display: none;" class="p-12 text-center text-gray-500">
                No students found. Add your first student to get started.
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">Add New Student</h2>
                <form id="add-form" onsubmit="handleAddStudent(event)">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                <input type="text" id="add-firstName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                <input type="text" id="add-lastName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                            <input type="email" id="add-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" id="add-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" />
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Age *</label>
                                <input type="number" id="add-age" required min="4" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Belt Rank</label>
                                <select id="add-beltRank" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                                    <option>White</option>
                                    <option>Yellow</option>
                                    <option>Orange</option>
                                    <option>Green</option>
                                    <option>Blue</option>
                                    <option>Purple</option>
                                    <option>Brown</option>
                                    <option>Black</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="add-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                                <option>Active</option>
                                <option>Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeAddModal()" class="flex-1 btn btn-secondary">Cancel</button>
                        <button type="submit" class="flex-1 btn btn-primary">Add Student</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">Edit Student</h2>
                <form id="edit-form" onsubmit="handleEditStudent(event)">
                    <input type="hidden" id="edit-id" />
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                <input type="text" id="edit-firstName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                <input type="text" id="edit-lastName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                            <input type="email" id="edit-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" id="edit-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" />
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Age *</label>
                                <input type="number" id="edit-age" required min="4" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Belt Rank</label>
                                <select id="edit-beltRank" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                                    <option>White</option>
                                    <option>Yellow</option>
                                    <option>Orange</option>
                                    <option>Green</option>
                                    <option>Blue</option>
                                    <option>Purple</option>
                                    <option>Brown</option>
                                    <option>Black</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="edit-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                                <option>Active</option>
                                <option>Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeEditModal()" class="flex-1 btn btn-secondary">Cancel</button>
                        <button type="submit" class="flex-1 btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4 text-red-600">Delete Student</h2>
                <p class="text-gray-700 mb-6">Are you sure you want to delete <strong id="delete-student-name"></strong>? This action cannot be undone.</p>
                <div class="flex gap-3">
                    <button onclick="closeDeleteModal()" class="flex-1 btn btn-secondary">Cancel</button>
                    <button onclick="confirmDelete()" class="flex-1 btn btn-danger">Delete Student</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allStudents = [];
        let studentToDelete = null;

        // Fetch students on page load
        async function fetchStudents() {
            try {
                const response = await fetch('/api/trpc/students.list', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch students');
                }

                const data = await response.json();
                // tRPC response format: { result: { data: { json: [...] } } }
                if (data.result && data.result.data) {
                    // Check if data is wrapped in json property
                    allStudents = data.result.data.json || data.result.data || [];
                } else {
                    allStudents = [];
                }
                
                // Ensure allStudents is an array
                if (!Array.isArray(allStudents)) {
                    console.error('Invalid data format:', allStudents);
                    allStudents = [];
                }
                
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('table-container').style.display = allStudents.length > 0 ? 'block' : 'none';
                document.getElementById('empty-state').style.display = allStudents.length === 0 ? 'block' : 'none';
                
                renderStudents();
            } catch (error) {
                console.error('Error fetching students:', error);
                document.getElementById('loading-state').innerHTML = '<p class="text-red-600">Error loading students. Please refresh the page.</p>';
            }
        }

        function renderStudents() {
            const tbody = document.getElementById('students-table-body');
            const filteredStudents = getFilteredStudents();
            
            document.getElementById('student-count').textContent = allStudents.length;

            if (filteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No students match your search criteria.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredStudents.map(student => `
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="openEditModalForStudent(${student.id})">
                    <td class="px-6 py-4 font-medium text-gray-900">${student.firstName} ${student.lastName}</td>
                    <td class="px-6 py-4 text-gray-600">${student.email || 'N/A'}</td>
                    <td class="px-6 py-4 text-gray-600">${student.phone || 'N/A'}</td>
                    <td class="px-6 py-4 text-gray-600">${student.age || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <span class="badge" style="background: #ddd6fe; color: #5b21b6;">${student.beltRank || 'White'}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="badge ${student.status === 'Active' ? 'badge-active' : 'badge-inactive'}">${student.status}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="event.stopPropagation(); openDeleteModalForStudent(${student.id})" class="text-red-600 hover:text-red-800 font-medium">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function getFilteredStudents() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;

            return allStudents.filter(student => {
                const matchesSearch = 
                    student.firstName.toLowerCase().includes(searchTerm) ||
                    student.lastName.toLowerCase().includes(searchTerm) ||
                    (student.email && student.email.toLowerCase().includes(searchTerm)) ||
                    (student.phone && student.phone.includes(searchTerm));

                const matchesStatus = statusFilter === 'All' || student.status === statusFilter;

                return matchesSearch && matchesStatus;
            });
        }

        function filterStudents() {
            renderStudents();
        }

        // Add Student
        function openAddModal() {
            document.getElementById('add-modal').classList.add('active');
            document.getElementById('add-form').reset();
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.remove('active');
        }

        async function handleAddStudent(event) {
            event.preventDefault();
            
            const studentData = {
                firstName: document.getElementById('add-firstName').value,
                lastName: document.getElementById('add-lastName').value,
                email: document.getElementById('add-email').value,
                phone: document.getElementById('add-phone').value,
                age: parseInt(document.getElementById('add-age').value),
                beltRank: document.getElementById('add-beltRank').value,
                status: document.getElementById('add-status').value,
                membershipStatus: 'Active'
            };

            try {
                const response = await fetch('/api/trpc/students.create?batch=1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ "0": { json: studentData } }),
                });

                if (!response.ok) {
                    throw new Error('Failed to add student');
                }

                closeAddModal();
                await fetchStudents();
                alert('Student added successfully!');
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error adding student. Please try again.');
            }
        }

        // Edit Student
        function openEditModalForStudent(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;

            document.getElementById('edit-id').value = student.id;
            document.getElementById('edit-firstName').value = student.firstName;
            document.getElementById('edit-lastName').value = student.lastName;
            document.getElementById('edit-email').value = student.email || '';
            document.getElementById('edit-phone').value = student.phone || '';
            document.getElementById('edit-age').value = student.age || '';
            document.getElementById('edit-beltRank').value = student.beltRank || 'White';
            document.getElementById('edit-status').value = student.status;

            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        async function handleEditStudent(event) {
            event.preventDefault();
            
            const studentData = {
                id: parseInt(document.getElementById('edit-id').value),
                firstName: document.getElementById('edit-firstName').value,
                lastName: document.getElementById('edit-lastName').value,
                email: document.getElementById('edit-email').value,
                phone: document.getElementById('edit-phone').value,
                age: parseInt(document.getElementById('edit-age').value),
                beltRank: document.getElementById('edit-beltRank').value,
                status: document.getElementById('edit-status').value,
                membershipStatus: 'Active'
            };

            try {
                const response = await fetch('/api/trpc/students.update?batch=1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ "0": { json: studentData } }),
                });

                if (!response.ok) {
                    throw new Error('Failed to update student');
                }

                closeEditModal();
                await fetchStudents();
                alert('Student updated successfully!');
            } catch (error) {
                console.error('Error updating student:', error);
                alert('Error updating student. Please try again.');
            }
        }

        // Delete Student
        function openDeleteModalForStudent(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;

            studentToDelete = studentId;
            document.getElementById('delete-student-name').textContent = `${student.firstName} ${student.lastName}`;
            document.getElementById('delete-modal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
            studentToDelete = null;
        }

        async function confirmDelete() {
            if (!studentToDelete) return;

            try {
                const response = await fetch('/api/trpc/students.delete?batch=1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ "0": { json: { id: studentToDelete } } }),
                });

                if (!response.ok) {
                    throw new Error('Failed to delete student');
                }

                closeDeleteModal();
                await fetchStudents();
                alert('Student deleted successfully!');
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('Error deleting student. Please try again.');
            }
        }

        // Initialize
        fetchStudents();
    </script>
</body>
</html>
